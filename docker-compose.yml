services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: flowershop-sqlserver
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${DB_PASSWORD:-YourStrong@Password123}
      - MSSQL_PID=Express
    ports:
      - "${DB_PORT:-1433}:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
      - ./init-db:/docker-entrypoint-initdb.d
    networks:
      - flowershop-network
    healthcheck:
      test: ["CMD-SHELL", "sleep 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  sqlserver-init:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: flowershop-sqlserver-init
    environment:
      - ACCEPT_EULA=Y
    volumes:
      - ./init-db:/init-db
    networks:
      - flowershop-network
    depends_on:
      sqlserver:
        condition: service_healthy
    command: >
      bash -c "
      echo 'Waiting for SQL Server to be ready...';
      sleep 5;
      echo 'Creating database...';
      /opt/mssql-tools/bin/sqlcmd -S sqlserver -U sa -P '${DB_PASSWORD:-YourStrong@Password123}' -i /init-db/01-create-database.sql;
      echo 'Database initialization complete';
      "
    restart: "no"

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: flowershop-app
    ports:
      - "${APP_PORT:-8080}:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILE:-prod}
      - SPRING_DATASOURCE_URL=jdbc:sqlserver://sqlserver:1433;databaseName=${DB_NAME:-AsmJava5};encrypt=true;trustServerCertificate=true
      - SPRING_DATASOURCE_USERNAME=${DB_USER:-sa}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD:-YourStrong@Password123}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${DDL_AUTO:-update}
      - SPRING_JPA_SHOW_SQL=${SHOW_SQL:-false}
      - SPRING_THYMELEAF_CACHE=${THYMELEAF_CACHE:-true}
      - UPLOAD_PATH=/app/uploads/products
      - JAVA_OPTS=-Xms512m -Xmx1024m
    volumes:
      - app_uploads:/app/uploads
      - app_logs:/app/logs
    depends_on:
      sqlserver:
        condition: service_healthy
      sqlserver-init:
        condition: service_completed_successfully
    networks:
      - flowershop-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1.5G
        reservations:
          memory: 512M

  # Optional: Nginx reverse proxy for production
  nginx:
    image: nginx:alpine
    container_name: flowershop-nginx
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./src/main/resources/static/uploads:/usr/share/nginx/html/uploads:ro
    depends_on:
      - app
    networks:
      - flowershop-network
    restart: unless-stopped
    profiles:
      - with-nginx

volumes:
  sqlserver_data:
    driver: local
  app_uploads:
    driver: local
  app_logs:
    driver: local

networks:
  flowershop-network:
    driver: bridge
